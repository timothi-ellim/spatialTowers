//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.42000
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

namespace Improbable.Gdk.CodeGenerator {
    using System;
    using Improbable.CodeGeneration.Jobs;
    
    
    public partial class UnityComponentConversionGenerator : UnityComponentConversionGeneratorBase {
        
        public virtual string TransformText() {
            this.GenerationEnvironment = null;
            
            #line 3 "Templates\UnityComponentConversionGenerator.tt"

    var fieldDetailsList = GetFieldDetailsList();
    var componentDetails = GetComponentDetails();
    var generatedHeader = CommonGeneratorUtils.GetGeneratedHeader();
    var commandDetailsList = GetCommandDetailsList();
    var eventDetailsList = GetEventDetailsList();
    var componentNamespace = qualifiedNamespace + "." + componentDetails.ComponentName;
    var profilingStart = $"Profiler.BeginSample(\"{componentDetails.ComponentName}\");";
    var profilingEnd = "Profiler.EndSample();";

            
            #line default
            #line hidden
            
            #line 13 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( generatedHeader ));
            
            #line default
            #line hidden
            
            #line 13 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"

using System;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;
using UnityEngine.Profiling;
using Unity.Mathematics;
using Unity.Entities;
using Unity.Collections;
using Improbable.Worker.Core;
using Improbable.Gdk.Core;
using Improbable.Gdk.Core.CodegenAdapters;
using Improbable.Gdk.Core.Commands;

namespace ");
            
            #line default
            #line hidden
            
            #line 28 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 28 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n{\r\n    public partial class ");
            
            #line default
            #line hidden
            
            #line 30 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 30 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n    {\r\n        internal class DispatcherHandler : ComponentDispatcherHandler\r\n " +
                    "       {\r\n            public override uint ComponentId => ");
            
            #line default
            #line hidden
            
            #line 34 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentId ));
            
            #line default
            #line hidden
            
            #line 34 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(";\r\n\r\n            private readonly EntityManager entityManager;\r\n\r\n            pri" +
                    "vate const string LoggerName = \"");
            
            #line default
            #line hidden
            
            #line 38 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 38 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".DispatcherHandler\";\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 40 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 41 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            private CommandStorages.");
            
            #line default
            #line hidden
            
            #line 41 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName));
            
            #line default
            #line hidden
            
            #line 41 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" ");
            
            #line default
            #line hidden
            
            #line 41 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 41 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage;\r\n");
            
            #line default
            #line hidden
            
            #line 42 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 43 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"
            public DispatcherHandler(WorkerSystem worker, World world) : base(worker, world)
            {
                entityManager = world.GetOrCreateManager<EntityManager>();
                var bookkeepingSystem = world.GetOrCreateManager<CommandRequestTrackerSystem>();
");
            
            #line default
            #line hidden
            
            #line 48 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 49 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 49 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 49 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage = bookkeepingSystem.GetCommandStorageForType<CommandStorages.");
            
            #line default
            #line hidden
            
            #line 49 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 49 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n");
            
            #line default
            #line hidden
            
            #line 50 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 51 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n\r\n            public override void Dispose()\r\n            {\r\n     " +
                    "           ");
            
            #line default
            #line hidden
            
            #line 55 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 55 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.UpdatesProvider.CleanDataInWorld(World);\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 57 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var fieldDetails in fieldDetailsList) { 
            
            #line default
            #line hidden
            
            #line 58 "Templates\UnityComponentConversionGenerator.tt"
 if (!fieldDetails.IsBlittable) { 
            
            #line default
            #line hidden
            
            #line 59 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 59 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 59 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 59 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( fieldDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 59 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.CleanDataInWorld(World);\r\n");
            
            #line default
            #line hidden
            
            #line 60 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 61 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 62 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetails in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 63 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 63 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 63 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 63 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 63 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.CleanDataInWorld(World);\r\n");
            
            #line default
            #line hidden
            
            #line 64 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 65 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 66 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 66 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 66 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 66 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 66 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("SenderProvider.CleanDataInWorld(World);\r\n                ");
            
            #line default
            #line hidden
            
            #line 67 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 67 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 67 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 67 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestsProvider.CleanDataInWorld(World);\r\n                ");
            
            #line default
            #line hidden
            
            #line 68 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 68 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 68 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 68 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponderProvider.CleanDataInWorld(World);\r\n                ");
            
            #line default
            #line hidden
            
            #line 69 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 69 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 69 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 69 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponsesProvider.CleanDataInWorld(World);\r\n");
            
            #line default
            #line hidden
            
            #line 70 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 71 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n\r\n            public override void OnAddComponent(AddComponentOp o" +
                    "p)\r\n            {\r\n                var entity = TryGetEntityFromEntityId(op.Enti" +
                    "tyId);\r\n\r\n                ");
            
            #line default
            #line hidden
            
            #line 77 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingStart ));
            
            #line default
            #line hidden
            
            #line 77 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                var data = ");
            
            #line default
            #line hidden
            
            #line 78 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 78 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Serialization.Deserialize(op.Data.SchemaData.Value.GetFields(), World);
                data.MarkDataClean();
                entityManager.AddComponentData(entity, data);
                entityManager.AddComponent(entity, ComponentType.Create<NotAuthoritative<");
            
            #line default
            #line hidden
            
            #line 81 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 81 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>());\r\n\r\n                var update = new ");
            
            #line default
            #line hidden
            
            #line 83 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 83 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Update\r\n                {\r\n");
            
            #line default
            #line hidden
            
            #line 85 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var fieldDetails in fieldDetailsList) { 
            
            #line default
            #line hidden
            
            #line 86 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    ");
            
            #line default
            #line hidden
            
            #line 86 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( fieldDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 86 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" = data.");
            
            #line default
            #line hidden
            
            #line 86 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( fieldDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 86 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(",\r\n");
            
            #line default
            #line hidden
            
            #line 87 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 88 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                };\r\n\r\n                var updates = new List<");
            
            #line default
            #line hidden
            
            #line 90 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 90 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Update>\r\n                {\r\n                    update\r\n                };\r\n\r\n  " +
                    "              var updatesComponent = new ");
            
            #line default
            #line hidden
            
            #line 95 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 95 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".ReceivedUpdates
                {
                    handle = ReferenceTypeProviders.UpdatesProvider.Allocate(World)
                };

                ReferenceTypeProviders.UpdatesProvider.Set(updatesComponent.handle, updates);
                entityManager.AddComponentData(entity, updatesComponent);

                if (entityManager.HasComponent<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 103 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 103 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity))\r\n                {\r\n                    entityManager.Remov" +
                    "eComponent<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 105 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 105 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity);\r\n                }\r\n                else if (!entityManager" +
                    ".HasComponent<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 107 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 107 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity))\r\n                {\r\n                    entityManager.AddCo" +
                    "mponent(entity, ComponentType.Create<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 109 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 109 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>());
                }
                else
                {
                    LogDispatcher.HandleLog(LogType.Error, new LogEvent(ReceivedDuplicateComponentAdded)
                        .WithField(LoggingUtils.LoggerName, LoggerName)
                        .WithField(LoggingUtils.EntityId, op.EntityId.Id)
                        .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 116 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 116 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                    );\r\n                }\r\n\r\n                ");
            
            #line default
            #line hidden
            
            #line 120 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingEnd ));
            
            #line default
            #line hidden
            
            #line 120 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n            }\r\n\r\n            public override void OnRemoveComponent(RemoveCompo" +
                    "nentOp op)\r\n            {\r\n                var entity = TryGetEntityFromEntityId" +
                    "(op.EntityId);\r\n\r\n                ");
            
            #line default
            #line hidden
            
            #line 127 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingStart ));
            
            #line default
            #line hidden
            
            #line 127 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n");
            
            #line default
            #line hidden
            
            #line 128 "Templates\UnityComponentConversionGenerator.tt"
 if (!componentDetails.IsBlittable) { 
            
            #line default
            #line hidden
            
            #line 129 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                var data = entityManager.GetComponentData<");
            
            #line default
            #line hidden
            
            #line 130 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 130 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>(entity);\r\n");
            
            #line default
            #line hidden
            
            #line 131 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var fieldDetails in fieldDetailsList) { 
            
            #line default
            #line hidden
            
            #line 132 "Templates\UnityComponentConversionGenerator.tt"
 if (!fieldDetails.IsBlittable) { 
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( fieldDetails.PascalCaseName ));
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Free(data.");
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( fieldDetails.CamelCaseName ));
            
            #line default
            #line hidden
            
            #line 133 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Handle);\r\n");
            
            #line default
            #line hidden
            
            #line 134 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 135 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 136 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 137 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                entityManager.RemoveComponent<");
            
            #line default
            #line hidden
            
            #line 138 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 138 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>(entity);\r\n\r\n                if (entityManager.HasComponent<ComponentA" +
                    "dded<");
            
            #line default
            #line hidden
            
            #line 140 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 140 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity))\r\n                {\r\n                    entityManager.Remov" +
                    "eComponent<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 142 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 142 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity);\r\n                }\r\n                else if (!entityManager" +
                    ".HasComponent<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 144 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 144 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity))\r\n                {\r\n                    entityManager.AddCo" +
                    "mponent(entity, ComponentType.Create<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 146 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 146 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>());
                }
                else
                {
                    LogDispatcher.HandleLog(LogType.Error, new LogEvent(ReceivedDuplicateComponentRemoved)
                        .WithField(LoggingUtils.LoggerName, LoggerName)
                        .WithField(LoggingUtils.EntityId, op.EntityId.Id)
                        .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 153 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 153 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                    );\r\n                }\r\n\r\n                ");
            
            #line default
            #line hidden
            
            #line 157 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingEnd ));
            
            #line default
            #line hidden
            
            #line 157 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n            }\r\n\r\n            public override void OnComponentUpdate(ComponentUp" +
                    "dateOp op)\r\n            {\r\n                var entity = TryGetEntityFromEntityId" +
                    "(op.EntityId);\r\n\r\n                ");
            
            #line default
            #line hidden
            
            #line 164 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingStart ));
            
            #line default
            #line hidden
            
            #line 164 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                if (entityManager.HasComponent<NotAuthoritative<");
            
            #line default
            #line hidden
            
            #line 165 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 165 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity))\r\n                {\r\n                    var data = entityMa" +
                    "nager.GetComponentData<");
            
            #line default
            #line hidden
            
            #line 167 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 167 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>(entity);\r\n                    ");
            
            #line default
            #line hidden
            
            #line 168 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 168 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.ApplyUpdate(op.Update.SchemaData.Value, ref data);\r\n              " +
                    "      data.MarkDataClean();\r\n                    entityManager.SetComponentData(" +
                    "entity, data);\r\n                }\r\n\r\n                var update = ");
            
            #line default
            #line hidden
            
            #line 173 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 173 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.DeserializeUpdate(op.Update.SchemaData.Value);\r\n\r\n                " +
                    "List<");
            
            #line default
            #line hidden
            
            #line 175 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 175 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Update> updates;\r\n                if (entityManager.HasComponent<");
            
            #line default
            #line hidden
            
            #line 176 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 176 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates>(entity))\r\n                {\r\n                    updates = enti" +
                    "tyManager.GetComponentData<");
            
            #line default
            #line hidden
            
            #line 178 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 178 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates>(entity).Updates;\r\n                }\r\n                else\r\n    " +
                    "            {\r\n                    updates = ");
            
            #line default
            #line hidden
            
            #line 182 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 182 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Update.Pool.Count > 0 ? ");
            
            #line default
            #line hidden
            
            #line 182 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 182 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Update.Pool.Pop() : new List<");
            
            #line default
            #line hidden
            
            #line 182 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 182 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Update>();\r\n                    var updatesComponent = new ");
            
            #line default
            #line hidden
            
            #line 183 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 183 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".ReceivedUpdates
                    {
                        handle = ReferenceTypeProviders.UpdatesProvider.Allocate(World)
                    };
                    ReferenceTypeProviders.UpdatesProvider.Set(updatesComponent.handle, updates);
                    entityManager.AddComponentData(entity, updatesComponent);
                }

                updates.Add(update);

");
            
            #line default
            #line hidden
            
            #line 193 "Templates\UnityComponentConversionGenerator.tt"
 if (eventDetailsList.Count > 0) { 
            
            #line default
            #line hidden
            
            #line 194 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                var eventsObject = op.Update.SchemaData.Value.GetEvents();\r\n");
            
            #line default
            #line hidden
            
            #line 195 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetails in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 196 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                {\r\n                    var eventCount = eventsObject.GetObjectCou" +
                    "nt(");
            
            #line default
            #line hidden
            
            #line 197 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventIndex ));
            
            #line default
            #line hidden
            
            #line 197 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                    if (eventCount > 0)\r\n                    {\r\n             " +
                    "           // Create component to hold received events\r\n                        " +
                    "ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 201 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 201 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" eventsReceived;\r\n                        List<");
            
            #line default
            #line hidden
            
            #line 202 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.FqnPayloadType ));
            
            #line default
            #line hidden
            
            #line 202 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("> eventList;\r\n                        if (!entityManager.HasComponent<ReceivedEve" +
                    "nts.");
            
            #line default
            #line hidden
            
            #line 203 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 203 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity))\r\n                        {\r\n                            eventsReceived" +
                    " = new ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 205 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 205 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("() {\r\n                                handle = ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 206 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 206 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Allocate(World)\r\n                            };\r\n                       " +
                    "     eventList = new List<");
            
            #line default
            #line hidden
            
            #line 208 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.FqnPayloadType ));
            
            #line default
            #line hidden
            
            #line 208 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">((int) eventCount);\r\n                            ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 209 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 209 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"Provider.Set(eventsReceived.handle, eventList);
                            entityManager.AddComponentData(entity, eventsReceived);
                        }
                        else
                        {
                            eventsReceived = entityManager.GetComponentData<ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 214 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 214 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">(entity);
                            eventList = eventsReceived.Events;
                        }

                        // Deserialize events onto component
                        for (uint i = 0; i < eventCount; i++)
                        {
                            var e = ");
            
            #line default
            #line hidden
            
            #line 221 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.FqnPayloadType ));
            
            #line default
            #line hidden
            
            #line 221 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Deserialize(eventsObject.IndexObject(");
            
            #line default
            #line hidden
            
            #line 221 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventIndex ));
            
            #line default
            #line hidden
            
            #line 221 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(", i));\r\n                            eventList.Add(e);\r\n                        }\r" +
                    "\n                    }\r\n                }\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 227 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 228 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 229 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 229 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingEnd ));
            
            #line default
            #line hidden
            
            #line 229 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n            }\r\n\r\n            public override void OnAuthorityChange(AuthorityCh" +
                    "angeOp op)\r\n            {\r\n                var entity = TryGetEntityFromEntityId" +
                    "(op.EntityId);\r\n\r\n                ");
            
            #line default
            #line hidden
            
            #line 236 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingStart ));
            
            #line default
            #line hidden
            
            #line 236 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                ApplyAuthorityChange(entity, op.Authority, op.EntityId);\r\n     " +
                    "           ");
            
            #line default
            #line hidden
            
            #line 238 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingEnd ));
            
            #line default
            #line hidden
            
            #line 238 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n            }\r\n\r\n            public override void OnCommandRequest(CommandReque" +
                    "stOp op)\r\n            {\r\n                var commandIndex = op.Request.SchemaDat" +
                    "a.Value.GetCommandIndex();\r\n");
            
            #line default
            #line hidden
            
            #line 244 "Templates\UnityComponentConversionGenerator.tt"
 if (commandDetailsList.Count > 0) { 
            
            #line default
            #line hidden
            
            #line 245 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                ");
            
            #line default
            #line hidden
            
            #line 246 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingStart ));
            
            #line default
            #line hidden
            
            #line 246 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                switch (commandIndex)\r\n                {\r\n");
            
            #line default
            #line hidden
            
            #line 249 "Templates\UnityComponentConversionGenerator.tt"
 foreach(var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 250 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    case ");
            
            #line default
            #line hidden
            
            #line 250 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandIndex ));
            
            #line default
            #line hidden
            
            #line 250 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(":\r\n                        On");
            
            #line default
            #line hidden
            
            #line 251 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 251 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Request(op);\r\n                        break;\r\n");
            
            #line default
            #line hidden
            
            #line 253 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 254 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    default:\r\n                        throw new UnknownCommandInd" +
                    "exException(commandIndex, \"");
            
            #line default
            #line hidden
            
            #line 255 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 255 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\");\r\n                }\r\n\r\n                ");
            
            #line default
            #line hidden
            
            #line 258 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingEnd ));
            
            #line default
            #line hidden
            
            #line 258 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n");
            
            #line default
            #line hidden
            
            #line 259 "Templates\UnityComponentConversionGenerator.tt"
 } else { 
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                throw new UnknownCommandIndexException(commandIndex, \"");
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 260 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\");\r\n");
            
            #line default
            #line hidden
            
            #line 261 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 262 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n\r\n            public override void OnCommandResponse(CommandRespon" +
                    "seOp op)\r\n            {\r\n                var commandIndex = op.Response.CommandI" +
                    "ndex;\r\n");
            
            #line default
            #line hidden
            
            #line 267 "Templates\UnityComponentConversionGenerator.tt"
 if (commandDetailsList.Count > 0) { 
            
            #line default
            #line hidden
            
            #line 268 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                ");
            
            #line default
            #line hidden
            
            #line 269 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingStart ));
            
            #line default
            #line hidden
            
            #line 269 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                switch (commandIndex)\r\n                {\r\n");
            
            #line default
            #line hidden
            
            #line 272 "Templates\UnityComponentConversionGenerator.tt"
 foreach(var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 273 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    case ");
            
            #line default
            #line hidden
            
            #line 273 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandIndex ));
            
            #line default
            #line hidden
            
            #line 273 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(":\r\n                        On");
            
            #line default
            #line hidden
            
            #line 274 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 274 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Response(op);\r\n                        break;\r\n");
            
            #line default
            #line hidden
            
            #line 276 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 277 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    default:\r\n                        throw new UnknownCommandInd" +
                    "exException(commandIndex, \"");
            
            #line default
            #line hidden
            
            #line 278 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 278 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\");\r\n                }\r\n\r\n                ");
            
            #line default
            #line hidden
            
            #line 281 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingEnd ));
            
            #line default
            #line hidden
            
            #line 281 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n");
            
            #line default
            #line hidden
            
            #line 282 "Templates\UnityComponentConversionGenerator.tt"
 } else { 
            
            #line default
            #line hidden
            
            #line 283 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                throw new UnknownCommandIndexException(commandIndex, \"");
            
            #line default
            #line hidden
            
            #line 283 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 283 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\");\r\n");
            
            #line default
            #line hidden
            
            #line 284 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 285 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n\r\n            public override void AddCommandComponents(Unity.Enti" +
                    "ties.Entity entity)\r\n            {\r\n");
            
            #line default
            #line hidden
            
            #line 289 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 290 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                {\r\n                    var commandSender = new ");
            
            #line default
            #line hidden
            
            #line 291 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 291 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 291 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 291 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandSenders.");
            
            #line default
            #line hidden
            
            #line 291 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 291 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("();\r\n                    commandSender.CommandListHandle = ");
            
            #line default
            #line hidden
            
            #line 292 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 292 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 292 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 292 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 292 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 292 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("SenderProvider.Allocate(World);\r\n                    commandSender.RequestsToSend" +
                    " = new List<");
            
            #line default
            #line hidden
            
            #line 293 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 293 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 293 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 293 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 293 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 293 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Request>();\r\n\r\n                    entityManager.AddComponentData(entity, comman" +
                    "dSender);\r\n\r\n                    var commandResponder = new ");
            
            #line default
            #line hidden
            
            #line 297 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 297 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 297 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 297 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandResponders.");
            
            #line default
            #line hidden
            
            #line 297 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 297 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("();\r\n                    commandResponder.CommandListHandle = ");
            
            #line default
            #line hidden
            
            #line 298 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 298 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 298 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 298 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 298 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 298 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponderProvider.Allocate(World);\r\n                    commandResponder.Response" +
                    "sToSend = new List<");
            
            #line default
            #line hidden
            
            #line 299 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 299 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 299 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 299 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 299 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 299 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Response>();\r\n\r\n                    entityManager.AddComponentData(entity, comma" +
                    "ndResponder);\r\n                }\r\n");
            
            #line default
            #line hidden
            
            #line 303 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 304 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"            }

            private void ApplyAuthorityChange(Unity.Entities.Entity entity, Authority authority, global::Improbable.Worker.EntityId entityId)
            {
                switch (authority)
                {
                    case Authority.Authoritative:
                        if (!entityManager.HasComponent<NotAuthoritative<");
            
            #line default
            #line hidden
            
            #line 311 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 311 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>(entity))
                        {
                            LogInvalidAuthorityTransition(Authority.Authoritative, Authority.NotAuthoritative, entityId);
                            return;
                        }

                        entityManager.RemoveComponent<NotAuthoritative<");
            
            #line default
            #line hidden
            
            #line 317 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 317 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity);\r\n                        entityManager.AddComponent(entity," +
                    " ComponentType.Create<Authoritative<");
            
            #line default
            #line hidden
            
            #line 318 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 318 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>());\r\n\r\n                        // Add event senders\r\n");
            
            #line default
            #line hidden
            
            #line 321 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 322 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        {\r\n                            var eventSender = new Even" +
                    "tSender.");
            
            #line default
            #line hidden
            
            #line 323 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 323 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("()\r\n                            {\r\n                                handle = Refer" +
                    "enceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 325 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 325 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Allocate(World)\r\n                            };\r\n                       " +
                    "     ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 327 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 327 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Set(eventSender.handle, new List<");
            
            #line default
            #line hidden
            
            #line 327 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.FqnPayloadType ));
            
            #line default
            #line hidden
            
            #line 327 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">());\r\n                            entityManager.AddComponentData(entity, eventSe" +
                    "nder);\r\n                        }\r\n");
            
            #line default
            #line hidden
            
            #line 330 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 331 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        break;\r\n                    case Authority.AuthorityLossI" +
                    "mminent:\r\n                        if (!entityManager.HasComponent<Authoritative<" +
                    "");
            
            #line default
            #line hidden
            
            #line 333 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 333 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>(entity))
                        {
                            LogInvalidAuthorityTransition(Authority.AuthorityLossImminent, Authority.Authoritative, entityId);
                            return;
                        }

                        entityManager.AddComponent(entity, ComponentType.Create<AuthorityLossImminent<");
            
            #line default
            #line hidden
            
            #line 339 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 339 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>());\r\n                        break;\r\n                    case Author" +
                    "ity.NotAuthoritative:\r\n                        if (!entityManager.HasComponent<A" +
                    "uthoritative<");
            
            #line default
            #line hidden
            
            #line 342 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 342 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>(entity))
                        {
                            LogInvalidAuthorityTransition(Authority.NotAuthoritative, Authority.Authoritative, entityId);
                            return;
                        }

                        if (entityManager.HasComponent<AuthorityLossImminent<");
            
            #line default
            #line hidden
            
            #line 348 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 348 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity))\r\n                        {\r\n                            ent" +
                    "ityManager.RemoveComponent<AuthorityLossImminent<");
            
            #line default
            #line hidden
            
            #line 350 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 350 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity);\r\n                        }\r\n\r\n                        entit" +
                    "yManager.RemoveComponent<Authoritative<");
            
            #line default
            #line hidden
            
            #line 353 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 353 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity);\r\n                        entityManager.AddComponent(entity," +
                    " ComponentType.Create<NotAuthoritative<");
            
            #line default
            #line hidden
            
            #line 354 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 354 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>());\r\n\r\n                        // Remove event senders\r\n");
            
            #line default
            #line hidden
            
            #line 357 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 358 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        {\r\n                            var eventSender = entityMa" +
                    "nager.GetComponentData<EventSender.");
            
            #line default
            #line hidden
            
            #line 359 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 359 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity);\r\n                            ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 360 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 360 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Free(eventSender.handle);\r\n                            entityManager.Rem" +
                    "oveComponent<EventSender.");
            
            #line default
            #line hidden
            
            #line 361 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 361 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity);\r\n                        }\r\n");
            
            #line default
            #line hidden
            
            #line 363 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 364 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        break;\r\n                }\r\n\r\n                List<Authori" +
                    "ty> authorityChanges;\r\n                if (entityManager.HasComponent<AuthorityC" +
                    "hanges<");
            
            #line default
            #line hidden
            
            #line 368 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 368 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity))\r\n                {\r\n                    authorityChanges = " +
                    "entityManager.GetComponentData<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 370 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 370 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entity).Changes;\r\n\r\n                }\r\n                else\r\n       " +
                    "         {\r\n                    var changes = new AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 375 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 375 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>
                    {
                        Handle = AuthorityChangesProvider.Allocate(World)
                    };
                    AuthorityChangesProvider.Set(changes.Handle, new List<Authority>());
                    authorityChanges = changes.Changes;
                    entityManager.AddComponentData(entity, changes);
                }

                authorityChanges.Add(authority);
            }

            private void LogInvalidAuthorityTransition(Authority newAuthority, Authority expectedOldAuthority, global::Improbable.Worker.EntityId entityId)
            {
                LogDispatcher.HandleLog(LogType.Error, new LogEvent(InvalidAuthorityChange)
                    .WithField(LoggingUtils.LoggerName, LoggerName)
                    .WithField(LoggingUtils.EntityId, entityId.Id)
                    .WithField(""New Authority"", newAuthority)
                    .WithField(""Expected Old Authority"", expectedOldAuthority)
                    .WithField(""Component"", """);
            
            #line default
            #line hidden
            
            #line 394 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 394 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                );\r\n            }\r\n");
            
            #line default
            #line hidden
            
            #line 397 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) {
    var wrappedCommandRequestType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.{commandDetails.CommandName}.ReceivedRequest";
    var commandRequestBufferType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.CommandRequests.{commandDetails.CommandName}";

    var wrappedCommandResponseType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.{commandDetails.CommandName}.ReceivedResponse";
    var commandResponseBufferType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.CommandResponses.{commandDetails.CommandName}";

    var commandStorage = $"{commandDetails.CamelCaseCommandName}Storage";

            
            #line default
            #line hidden
            
            #line 406 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n            private void On");
            
            #line default
            #line hidden
            
            #line 407 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 407 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Request(CommandRequestOp op)\r\n            {\r\n                var entity = TryGetE" +
                    "ntityFromEntityId(op.EntityId);\r\n\r\n                var deserializedRequest = ");
            
            #line default
            #line hidden
            
            #line 411 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.FqnRequestType ));
            
            #line default
            #line hidden
            
            #line 411 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Deserialize(op.Request.SchemaData.Value.GetObject());\r\n\r\n         " +
                    "       List<");
            
            #line default
            #line hidden
            
            #line 413 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandRequestType ));
            
            #line default
            #line hidden
            
            #line 413 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("> requests;\r\n                if (entityManager.HasComponent<");
            
            #line default
            #line hidden
            
            #line 414 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandRequestBufferType ));
            
            #line default
            #line hidden
            
            #line 414 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity))\r\n                {\r\n                    requests = entityManager.GetCo" +
                    "mponentData<");
            
            #line default
            #line hidden
            
            #line 416 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandRequestBufferType ));
            
            #line default
            #line hidden
            
            #line 416 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity).Requests;\r\n                }\r\n                else\r\n                {\r\n" +
                    "                    var data = new ");
            
            #line default
            #line hidden
            
            #line 420 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandRequestBufferType ));
            
            #line default
            #line hidden
            
            #line 420 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                    {\r\n                        CommandListHandle = ");
            
            #line default
            #line hidden
            
            #line 422 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 422 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 422 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 422 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 422 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 422 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestsProvider.Allocate(World)\r\n                    };\r\n                    req" +
                    "uests = data.Requests = new List<");
            
            #line default
            #line hidden
            
            #line 424 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandRequestType ));
            
            #line default
            #line hidden
            
            #line 424 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n                    entityManager.AddComponentData(entity, data);\r\n        " +
                    "        }\r\n\r\n                requests.Add(new ");
            
            #line default
            #line hidden
            
            #line 428 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandRequestType ));
            
            #line default
            #line hidden
            
            #line 428 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("(op.RequestId.Id,\r\n                    op.CallerWorkerId,\r\n                    op" +
                    ".CallerAttributeSet,\r\n                    deserializedRequest));\r\n            }\r" +
                    "\n\r\n            private void On");
            
            #line default
            #line hidden
            
            #line 434 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 434 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Response(CommandResponseOp op)\r\n            {\r\n                if (!");
            
            #line default
            #line hidden
            
            #line 436 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandStorage ));
            
            #line default
            #line hidden
            
            #line 436 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandRequestsInFlight.TryGetValue(op.RequestId.Id, out var requestBundle))\r\n  " +
                    "              {\r\n                    throw new InvalidOperationException($\"Could" +
                    " not find corresponding request for RequestId {op.RequestId.Id} and command ");
            
            #line default
            #line hidden
            
            #line 438 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 438 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".\");\r\n                }\r\n\r\n                var entity = requestBundle.Entity;\r\n  " +
                    "              ");
            
            #line default
            #line hidden
            
            #line 442 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandStorage ));
            
            #line default
            #line hidden
            
            #line 442 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".CommandRequestsInFlight.Remove(op.RequestId.Id);
                if (!entityManager.Exists(entity))
                {
                    LogDispatcher.HandleLog(LogType.Log, new LogEvent(EntityNotFound)
                        .WithField(LoggingUtils.LoggerName, LoggerName)
                        .WithField(""Op"", ""CommandResponseOp - ");
            
            #line default
            #line hidden
            
            #line 447 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 447 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                        .WithField(\"Component\", \"");
            
            #line default
            #line hidden
            
            #line 448 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 448 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\")\r\n                    );\r\n                    return;\r\n                }\r\n\r\n   " +
                    "             ");
            
            #line default
            #line hidden
            
            #line 453 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.FqnResponseType ));
            
            #line default
            #line hidden
            
            #line 453 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("? response = null;\r\n                if (op.StatusCode == StatusCode.Success)\r\n   " +
                    "             {\r\n                    response = ");
            
            #line default
            #line hidden
            
            #line 456 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.FqnResponseType ));
            
            #line default
            #line hidden
            
            #line 456 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Deserialize(op.Response.SchemaData.Value.GetObject());\r\n          " +
                    "      }\r\n\r\n                List<");
            
            #line default
            #line hidden
            
            #line 459 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandResponseType ));
            
            #line default
            #line hidden
            
            #line 459 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("> responses;\r\n                if (entityManager.HasComponent<");
            
            #line default
            #line hidden
            
            #line 460 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandResponseBufferType ));
            
            #line default
            #line hidden
            
            #line 460 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity))\r\n                {\r\n                    responses = entityManager.GetC" +
                    "omponentData<");
            
            #line default
            #line hidden
            
            #line 462 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandResponseBufferType ));
            
            #line default
            #line hidden
            
            #line 462 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entity).Responses;\r\n                }\r\n                else\r\n                {\r" +
                    "\n                    var data = new ");
            
            #line default
            #line hidden
            
            #line 466 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandResponseBufferType ));
            
            #line default
            #line hidden
            
            #line 466 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                    {\r\n                        CommandListHandle = ");
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 468 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponsesProvider.Allocate(World)\r\n                    };\r\n                    re" +
                    "sponses = data.Responses = new List<");
            
            #line default
            #line hidden
            
            #line 470 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandResponseType ));
            
            #line default
            #line hidden
            
            #line 470 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n                    entityManager.AddComponentData(entity, data);\r\n        " +
                    "        }\r\n\r\n                responses.Add(new ");
            
            #line default
            #line hidden
            
            #line 474 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( wrappedCommandResponseType ));
            
            #line default
            #line hidden
            
            #line 474 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"(op.EntityId,
                    op.Message,
                    op.StatusCode,
                    response,
                    requestBundle.Request,
                    requestBundle.Context,
                    requestBundle.RequestId));
            }
");
            
            #line default
            #line hidden
            
            #line 482 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 483 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("        }\r\n\r\n        internal class ComponentReplicator : ComponentReplicationHan" +
                    "dler\r\n        {\r\n            public override uint ComponentId => ");
            
            #line default
            #line hidden
            
            #line 487 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentId ));
            
            #line default
            #line hidden
            
            #line 487 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(";\r\n\r\n            public override EntityArchetypeQuery ComponentUpdateQuery => new" +
                    " EntityArchetypeQuery\r\n            {\r\n                All = new[]\r\n             " +
                    "   {\r\n");
            
            #line default
            #line hidden
            
            #line 493 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 494 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    ComponentType.Create<EventSender.");
            
            #line default
            #line hidden
            
            #line 494 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 494 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n");
            
            #line default
            #line hidden
            
            #line 495 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 496 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    ComponentType.Create<");
            
            #line default
            #line hidden
            
            #line 496 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 496 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>(),\r\n                    ComponentType.ReadOnly<Authoritative<");
            
            #line default
            #line hidden
            
            #line 497 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 497 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>(),
                    ComponentType.ReadOnly<SpatialEntityId>()
                },
                Any = Array.Empty<ComponentType>(),
                None = Array.Empty<ComponentType>(),
            };

            public override EntityArchetypeQuery[] CommandQueries => new EntityArchetypeQuery[]
            {
");
            
            #line default
            #line hidden
            
            #line 506 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 507 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                new EntityArchetypeQuery()\r\n                {\r\n                  " +
                    "  All = new[]\r\n                    {\r\n                        ComponentType.Crea" +
                    "te<");
            
            #line default
            #line hidden
            
            #line 511 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 511 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 511 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 511 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandSenders.");
            
            #line default
            #line hidden
            
            #line 511 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 511 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n                        ComponentType.Create<");
            
            #line default
            #line hidden
            
            #line 512 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( qualifiedNamespace ));
            
            #line default
            #line hidden
            
            #line 512 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".");
            
            #line default
            #line hidden
            
            #line 512 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentName ));
            
            #line default
            #line hidden
            
            #line 512 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".CommandResponders.");
            
            #line default
            #line hidden
            
            #line 512 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 512 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n                    },\r\n                    Any = Array.Empty<ComponentType" +
                    ">(),\r\n                    None = Array.Empty<ComponentType>(),\r\n                " +
                    "},\r\n");
            
            #line default
            #line hidden
            
            #line 517 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 518 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            };\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 520 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 521 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            private CommandStorages.");
            
            #line default
            #line hidden
            
            #line 521 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName));
            
            #line default
            #line hidden
            
            #line 521 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" ");
            
            #line default
            #line hidden
            
            #line 521 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 521 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage;\r\n");
            
            #line default
            #line hidden
            
            #line 522 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 523 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n            public ComponentReplicator(EntityManager entityManager, Unity.Entit" +
                    "ies.World world) : base(entityManager)\r\n            {\r\n                var bookk" +
                    "eepingSystem = world.GetOrCreateManager<CommandRequestTrackerSystem>();\r\n");
            
            #line default
            #line hidden
            
            #line 527 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 528 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 528 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 528 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage = bookkeepingSystem.GetCommandStorageForType<CommandStorages.");
            
            #line default
            #line hidden
            
            #line 528 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName));
            
            #line default
            #line hidden
            
            #line 528 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n");
            
            #line default
            #line hidden
            
            #line 529 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 530 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("            }\r\n\r\n            public override void ExecuteReplication(ComponentGro" +
                    "up replicationGroup, ComponentSystemBase system, global::Improbable.Worker.Core." +
                    "Connection connection)\r\n            {\r\n                ");
            
            #line default
            #line hidden
            
            #line 534 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingStart ));
            
            #line default
            #line hidden
            
            #line 534 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"

                var chunkArray = replicationGroup.CreateArchetypeChunkArray(Allocator.TempJob);
                var spatialOSEntityType = system.GetArchetypeChunkComponentType<SpatialEntityId>(true);
                var componentType = system.GetArchetypeChunkComponentType<");
            
            #line default
            #line hidden
            
            #line 538 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 538 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>();\r\n");
            
            #line default
            #line hidden
            
            #line 539 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 540 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                var event");
            
            #line default
            #line hidden
            
            #line 540 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 540 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Type = system.GetArchetypeChunkComponentType<EventSender.");
            
            #line default
            #line hidden
            
            #line 540 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 540 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(true);\r\n");
            
            #line default
            #line hidden
            
            #line 541 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 542 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                foreach (var chunk in chunkArray)\r\n                {\r\n           " +
                    "         var entityIdArray = chunk.GetNativeArray(spatialOSEntityType);\r\n       " +
                    "             var componentArray = chunk.GetNativeArray(componentType);\r\n");
            
            #line default
            #line hidden
            
            #line 546 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 547 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    var event");
            
            #line default
            #line hidden
            
            #line 547 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 547 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Array = chunk.GetNativeArray(event");
            
            #line default
            #line hidden
            
            #line 547 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 547 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Type);\r\n");
            
            #line default
            #line hidden
            
            #line 548 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 549 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    for (var i = 0; i < componentArray.Length; i++)\r\n            " +
                    "        {\r\n                        var data = componentArray[i];\r\n              " +
                    "          var eventsToSend = 0;\r\n");
            
            #line default
            #line hidden
            
            #line 553 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 554 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                        var events");
            
            #line default
            #line hidden
            
            #line 554 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 554 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" = event");
            
            #line default
            #line hidden
            
            #line 554 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 554 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Array[i].Events;\r\n                        eventsToSend += events");
            
            #line default
            #line hidden
            
            #line 555 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 555 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Count;\r\n");
            
            #line default
            #line hidden
            
            #line 556 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 557 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                        if (data.IsDataDirty() || eventsToSend > 0)\r\n          " +
                    "              {\r\n                            var update = new global::Improbable" +
                    ".Worker.Core.SchemaComponentUpdate(");
            
            #line default
            #line hidden
            
            #line 560 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentId ));
            
            #line default
            #line hidden
            
            #line 560 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                            ");
            
            #line default
            #line hidden
            
            #line 561 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 561 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.SerializeUpdate(data, update);\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 563 "Templates\UnityComponentConversionGenerator.tt"
 if (eventDetailsList.Count > 0) { 
            
            #line default
            #line hidden
            
            #line 564 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                            // Serialize events\r\n                            var " +
                    "eventsObject = update.GetEvents();\r\n");
            
            #line default
            #line hidden
            
            #line 566 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetail in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 567 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                            if (events");
            
            #line default
            #line hidden
            
            #line 567 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 567 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Count > 0)\r\n                            {\r\n                                forea" +
                    "ch (var e in events");
            
            #line default
            #line hidden
            
            #line 569 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 569 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(")\r\n                                {\r\n                                    var obj" +
                    " = eventsObject.AddObject(");
            
            #line default
            #line hidden
            
            #line 571 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventIndex ));
            
            #line default
            #line hidden
            
            #line 571 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                                    ");
            
            #line default
            #line hidden
            
            #line 572 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.FqnPayloadType ));
            
            #line default
            #line hidden
            
            #line 572 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Serialization.Serialize(e, obj);\r\n                                }\r\n\r\n         " +
                    "                       events");
            
            #line default
            #line hidden
            
            #line 575 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetail.EventName ));
            
            #line default
            #line hidden
            
            #line 575 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Clear();\r\n                            }\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 578 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 579 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 580 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"                            // Send serialized update over the wire
                            connection.SendComponentUpdate(entityIdArray[i].EntityId, new global::Improbable.Worker.Core.ComponentUpdate(update));

                            data.MarkDataClean();
                            componentArray[i] = data;
                        }
                    }
                }

                chunkArray.Dispose();
                ");
            
            #line default
            #line hidden
            
            #line 590 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingEnd ));
            
            #line default
            #line hidden
            
            #line 590 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n            }\r\n\r\n            public override void SendCommands(ComponentGroup c" +
                    "ommandGroup, ComponentSystemBase system, global::Improbable.Worker.Core.Connecti" +
                    "on connection)\r\n            {\r\n");
            
            #line default
            #line hidden
            
            #line 595 "Templates\UnityComponentConversionGenerator.tt"
 if (commandDetailsList.Count > 0) { 
            
            #line default
            #line hidden
            
            #line 596 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                ");
            
            #line default
            #line hidden
            
            #line 596 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingStart ));
            
            #line default
            #line hidden
            
            #line 596 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                var entityType = system.GetArchetypeChunkEntityType();\r\n");
            
            #line default
            #line hidden
            
            #line 598 "Templates\UnityComponentConversionGenerator.tt"

for (var i = 0; i < commandDetailsList.Count; i++) {
    var commandDetails = commandDetailsList[i];
    var commandSenderType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.CommandSenders.{commandDetails.CommandName}";
    var commandResponderType = $"{qualifiedNamespace}.{componentDetails.ComponentName}.CommandResponders.{commandDetails.CommandName}";

            
            #line default
            #line hidden
            
            #line 604 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                {\r\n                    var senderType = system.GetArchetypeChunkC" +
                    "omponentType<");
            
            #line default
            #line hidden
            
            #line 605 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandSenderType ));
            
            #line default
            #line hidden
            
            #line 605 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(true);\r\n                    var responderType = system.GetArchetypeChunkCompone" +
                    "ntType<");
            
            #line default
            #line hidden
            
            #line 606 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandResponderType ));
            
            #line default
            #line hidden
            
            #line 606 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">(true);

                    var chunks = commandGroup.CreateArchetypeChunkArray(Allocator.TempJob);
                    foreach (var chunk in chunks)
                    {
                        var entities = chunk.GetNativeArray(entityType);
                        var senders = chunk.GetNativeArray(senderType);
                        var responders = chunk.GetNativeArray(responderType);
                        for (var i = 0; i < senders.Length; i++)
                        {
                            var requests = senders[i].RequestsToSend;
                            var responses = responders[i].ResponsesToSend;
                            if (requests.Count > 0)
                            {
                                foreach (var request in requests)
                                {
                                    var schemaCommandRequest = new global::Improbable.Worker.Core.SchemaCommandRequest(ComponentId, ");
            
            #line default
            #line hidden
            
            #line 622 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandIndex ));
            
            #line default
            #line hidden
            
            #line 622 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                                    ");
            
            #line default
            #line hidden
            
            #line 623 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.FqnRequestType ));
            
            #line default
            #line hidden
            
            #line 623 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Serialization.Serialize(request.Payload, schemaCommandRequest.GetObject());

                                    var requestId = connection.SendCommandRequest(request.TargetEntityId,
                                        new global::Improbable.Worker.Core.CommandRequest(schemaCommandRequest),
                                        request.TimeoutMillis,
                                        request.AllowShortCircuiting ? ShortCircuitParameters : null);

                                    ");
            
            #line default
            #line hidden
            
            #line 630 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 630 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Storage.CommandRequestsInFlight[requestId.Id] =\r\n                                " +
                    "        new CommandRequestStore<");
            
            #line default
            #line hidden
            
            #line 631 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.FqnRequestType ));
            
            #line default
            #line hidden
            
            #line 631 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@">(entities[i], request.Payload, request.Context, request.RequestId);
                                }

                                requests.Clear();
                            }

                            if (responses.Count > 0)
                            {
                                foreach (var response in responses)
                                {
                                    var requestId = new global::Improbable.Worker.Core.RequestId<IncomingCommandRequest>(response.RequestId);

                                    if (response.FailureMessage != null)
                                    {
                                        // Send a command failure if the string is non-null.
                                        connection.SendCommandFailure(requestId, response.FailureMessage);
                                        continue;
                                    }

                                    var schemaCommandResponse = new global::Improbable.Worker.Core.SchemaCommandResponse(ComponentId, ");
            
            #line default
            #line hidden
            
            #line 650 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandIndex ));
            
            #line default
            #line hidden
            
            #line 650 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                                    ");
            
            #line default
            #line hidden
            
            #line 651 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.FqnResponseType ));
            
            #line default
            #line hidden
            
            #line 651 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Serialization.Serialize(response.Payload.Value, schemaCommandResponse.GetObject());

                                    connection.SendCommandResponse(requestId, new global::Improbable.Worker.Core.CommandResponse(schemaCommandResponse));
                                }

                                responses.Clear();
                            }
                        }
                    }

                    chunks.Dispose();
                }
");
            
            #line default
            #line hidden
            
            #line 663 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 664 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                ");
            
            #line default
            #line hidden
            
            #line 665 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( profilingEnd ));
            
            #line default
            #line hidden
            
            #line 665 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n");
            
            #line default
            #line hidden
            
            #line 666 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 667 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"            }
        }

        internal class ComponentCleanup : ComponentCleanupHandler
        {
            public override EntityArchetypeQuery CleanupArchetypeQuery => new EntityArchetypeQuery
            {
                All = Array.Empty<ComponentType>(),
                Any = new ComponentType[]
                {
                    ComponentType.Create<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 677 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 677 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(),\r\n                    ComponentType.Create<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 678 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 678 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(),\r\n                    ComponentType.Create<");
            
            #line default
            #line hidden
            
            #line 679 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 679 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates>(),\r\n                    ComponentType.Create<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 680 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 680 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(),\r\n");
            
            #line default
            #line hidden
            
            #line 681 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var eventDetails in eventDetailsList) { 
            
            #line default
            #line hidden
            
            #line 682 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    ComponentType.Create<ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 682 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 682 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n");
            
            #line default
            #line hidden
            
            #line 683 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 684 "Templates\UnityComponentConversionGenerator.tt"
 foreach (var commandDetails in commandDetailsList) { 
            
            #line default
            #line hidden
            
            #line 685 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    ComponentType.Create<CommandRequests.");
            
            #line default
            #line hidden
            
            #line 685 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 685 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n                    ComponentType.Create<CommandResponses.");
            
            #line default
            #line hidden
            
            #line 686 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 686 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(),\r\n");
            
            #line default
            #line hidden
            
            #line 687 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 688 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"                },
                None = Array.Empty<ComponentType>(),
            };

            public override void CleanComponents(ComponentGroup group, ComponentSystemBase system,
                EntityCommandBuffer buffer)
            {
                var entityType = system.GetArchetypeChunkEntityType();
                var componentAddedType = system.GetArchetypeChunkComponentType<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 696 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 696 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>();\r\n                var componentRemovedType = system.GetArchetypeCh" +
                    "unkComponentType<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 697 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 697 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>();\r\n                var receivedUpdateType = system.GetArchetypeChun" +
                    "kComponentType<");
            
            #line default
            #line hidden
            
            #line 698 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 698 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".ReceivedUpdates>();\r\n                var authorityChangeType = system.GetArchety" +
                    "peChunkComponentType<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 699 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 699 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>();\r\n");
            
            #line default
            #line hidden
            
            #line 700 "Templates\UnityComponentConversionGenerator.tt"

for (var i = 0; i < eventDetailsList.Count; i++) {
var eventDetails = eventDetailsList[i];

            
            #line default
            #line hidden
            
            #line 704 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                var ");
            
            #line default
            #line hidden
            
            #line 704 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.CamelCaseEventName ));
            
            #line default
            #line hidden
            
            #line 704 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("EventType = system.GetArchetypeChunkComponentType<ReceivedEvents.");
            
            #line default
            #line hidden
            
            #line 704 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 704 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n");
            
            #line default
            #line hidden
            
            #line 705 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 706 "Templates\UnityComponentConversionGenerator.tt"

for (var j = 0; j < commandDetailsList.Count; j++) {
    var commandDetails = commandDetailsList[j];

            
            #line default
            #line hidden
            
            #line 710 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("\r\n                var ");
            
            #line default
            #line hidden
            
            #line 711 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 711 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestType = system.GetArchetypeChunkComponentType<CommandRequests.");
            
            #line default
            #line hidden
            
            #line 711 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 711 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n                var ");
            
            #line default
            #line hidden
            
            #line 712 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 712 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponseType = system.GetArchetypeChunkComponentType<CommandResponses.");
            
            #line default
            #line hidden
            
            #line 712 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 712 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">();\r\n");
            
            #line default
            #line hidden
            
            #line 713 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 714 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"
                var chunkArray = group.CreateArchetypeChunkArray(Allocator.TempJob);

                foreach (var chunk in chunkArray)
                {
                    var entities = chunk.GetNativeArray(entityType);

                    // Updates
                    if (chunk.Has(receivedUpdateType))
                    {
                        var updateArray = chunk.GetNativeArray(receivedUpdateType);
                        for (int i = 0; i < entities.Length; ++i)
                        {
                            buffer.RemoveComponent<");
            
            #line default
            #line hidden
            
            #line 727 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 727 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".ReceivedUpdates>(entities[i]);
                            var updateList = updateArray[i].Updates;

                            // Pool update lists to avoid excessive allocation
                            updateList.Clear();
                            ");
            
            #line default
            #line hidden
            
            #line 732 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 732 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Update.Pool.Push(updateList);

                            ReferenceTypeProviders.UpdatesProvider.Free(updateArray[i].handle);
                        }
                    }

                    // Component Added
                    if (chunk.Has(componentAddedType))
                    {
                        for (int i = 0; i < entities.Length; ++i)
                        {
                            buffer.RemoveComponent<ComponentAdded<");
            
            #line default
            #line hidden
            
            #line 743 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 743 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>(entities[i]);
                        }
                    }

                    // Component Removed
                    if (chunk.Has(componentRemovedType))
                    {
                        for (int i = 0; i < entities.Length; ++i)
                        {
                            buffer.RemoveComponent<ComponentRemoved<");
            
            #line default
            #line hidden
            
            #line 752 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 752 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>(entities[i]);
                        }
                    }

                    // Authority
                    if (chunk.Has(authorityChangeType))
                    {
                        var authorityChangeArray = chunk.GetNativeArray(authorityChangeType);
                        for (int i = 0; i < entities.Length; ++i)
                        {
                            buffer.RemoveComponent<AuthorityChanges<");
            
            #line default
            #line hidden
            
            #line 762 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 762 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(".Component>>(entities[i]);\r\n                            AuthorityChangesProvider." +
                    "Free(authorityChangeArray[i].Handle);\r\n                        }\r\n              " +
                    "      }\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 767 "Templates\UnityComponentConversionGenerator.tt"

for (var i = 0; i < eventDetailsList.Count; i++) {
var eventDetails = eventDetailsList[i];

            
            #line default
            #line hidden
            
            #line 771 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    // ");
            
            #line default
            #line hidden
            
            #line 771 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 771 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" Event\r\n                    if (chunk.Has(");
            
            #line default
            #line hidden
            
            #line 772 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.CamelCaseEventName ));
            
            #line default
            #line hidden
            
            #line 772 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("EventType))\r\n                    {\r\n                        var ");
            
            #line default
            #line hidden
            
            #line 774 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.CamelCaseEventName ));
            
            #line default
            #line hidden
            
            #line 774 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("EventArray = chunk.GetNativeArray(");
            
            #line default
            #line hidden
            
            #line 774 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.CamelCaseEventName ));
            
            #line default
            #line hidden
            
            #line 774 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("EventType);\r\n                        for (int i = 0; i < entities.Length; ++i)\r\n " +
                    "                       {\r\n                            buffer.RemoveComponent<Rec" +
                    "eivedEvents.");
            
            #line default
            #line hidden
            
            #line 777 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 777 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entities[i]);\r\n                            ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 778 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.EventName ));
            
            #line default
            #line hidden
            
            #line 778 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("Provider.Free(");
            
            #line default
            #line hidden
            
            #line 778 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( eventDetails.CamelCaseEventName ));
            
            #line default
            #line hidden
            
            #line 778 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("EventArray[i].handle);\r\n                        }\r\n                    }\r\n\r\n");
            
            #line default
            #line hidden
            
            #line 782 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 783 "Templates\UnityComponentConversionGenerator.tt"

for (var j = 0; j < commandDetailsList.Count; j++) {
    var commandDetails = commandDetailsList[j];

            
            #line default
            #line hidden
            
            #line 787 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("                    // ");
            
            #line default
            #line hidden
            
            #line 787 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 787 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(" Command\r\n                    if (chunk.Has(");
            
            #line default
            #line hidden
            
            #line 788 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 788 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestType))\r\n                    {\r\n                            var ");
            
            #line default
            #line hidden
            
            #line 790 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 790 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestArray = chunk.GetNativeArray(");
            
            #line default
            #line hidden
            
            #line 790 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 790 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestType);\r\n                        for (int i = 0; i < entities.Length; ++i)\r" +
                    "\n                        {\r\n                            buffer.RemoveComponent<C" +
                    "ommandRequests.");
            
            #line default
            #line hidden
            
            #line 793 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 793 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entities[i]);\r\n                            ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 794 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 794 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestsProvider.Free(");
            
            #line default
            #line hidden
            
            #line 794 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 794 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("RequestArray[i].CommandListHandle);\r\n                        }\r\n                 " +
                    "   }\r\n\r\n                    if (chunk.Has(");
            
            #line default
            #line hidden
            
            #line 798 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 798 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponseType))\r\n                    {\r\n                        var ");
            
            #line default
            #line hidden
            
            #line 800 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 800 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponseArray = chunk.GetNativeArray(");
            
            #line default
            #line hidden
            
            #line 800 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 800 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponseType);\r\n                        for (int i = 0; i < entities.Length; ++i)" +
                    "\r\n                        {\r\n                            buffer.RemoveComponent<" +
                    "CommandResponses.");
            
            #line default
            #line hidden
            
            #line 803 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 803 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(">(entities[i]);\r\n                            ReferenceTypeProviders.");
            
            #line default
            #line hidden
            
            #line 804 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CommandName ));
            
            #line default
            #line hidden
            
            #line 804 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponsesProvider.Free(");
            
            #line default
            #line hidden
            
            #line 804 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( commandDetails.CamelCaseCommandName ));
            
            #line default
            #line hidden
            
            #line 804 "Templates\UnityComponentConversionGenerator.tt"
            this.Write("ResponseArray[i].CommandListHandle);\r\n                        }\r\n                " +
                    "    }\r\n");
            
            #line default
            #line hidden
            
            #line 807 "Templates\UnityComponentConversionGenerator.tt"
 } 
            
            #line default
            #line hidden
            
            #line 808 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@"                }

                chunkArray.Dispose();
            }
        }

        internal class AcknowledgeAuthorityLossHandler : AbstractAcknowledgeAuthorityLossHandler
        {
            public override EntityArchetypeQuery Query => new EntityArchetypeQuery
            {
                All = new ComponentType[]
                {
                    ComponentType.ReadOnly<AuthorityLossImminent<");
            
            #line default
            #line hidden
            
            #line 820 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 820 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>(),
                    ComponentType.ReadOnly<SpatialEntityId>()
                },
                Any = Array.Empty<ComponentType>(),
                None = Array.Empty<ComponentType>()
            };

            public override void AcknowledgeAuthorityLoss(ComponentGroup group, ComponentSystemBase system,
                Improbable.Worker.Core.Connection connection)
            {
                var authorityLossType = system.GetArchetypeChunkComponentType<AuthorityLossImminent<");
            
            #line default
            #line hidden
            
            #line 830 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentNamespace ));
            
            #line default
            #line hidden
            
            #line 830 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(@".Component>>();
                var spatialEntityType = system.GetArchetypeChunkComponentType<SpatialEntityId>();

                var chunkArray = group.CreateArchetypeChunkArray(Allocator.TempJob);

                foreach (var chunk in chunkArray)
                {
                    var authorityArray = chunk.GetNativeArray(authorityLossType);
                    var spatialEntityIdArray = chunk.GetNativeArray(spatialEntityType);

                    for (int i = 0; i < authorityArray.Length; ++i)
                    {
                        if (authorityArray[i].AcknowledgeAuthorityLoss)
                        {
                            connection.SendAuthorityLossImminentAcknowledgement(spatialEntityIdArray[i].EntityId,
                                ");
            
            #line default
            #line hidden
            
            #line 845 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture( componentDetails.ComponentId ));
            
            #line default
            #line hidden
            
            #line 845 "Templates\UnityComponentConversionGenerator.tt"
            this.Write(");\r\n                        }\r\n                    }\r\n                }\r\n\r\n      " +
                    "          chunkArray.Dispose();\r\n            }\r\n        }\r\n    }\r\n}\r\n");
            
            #line default
            #line hidden
            return this.GenerationEnvironment.ToString();
        }
        
        public virtual void Initialize() {
        }
    }
    
    public class UnityComponentConversionGeneratorBase {
        
        private global::System.Text.StringBuilder builder;
        
        private global::System.Collections.Generic.IDictionary<string, object> session;
        
        private global::System.CodeDom.Compiler.CompilerErrorCollection errors;
        
        private string currentIndent = string.Empty;
        
        private global::System.Collections.Generic.Stack<int> indents;
        
        private ToStringInstanceHelper _toStringHelper = new ToStringInstanceHelper();
        
        public virtual global::System.Collections.Generic.IDictionary<string, object> Session {
            get {
                return this.session;
            }
            set {
                this.session = value;
            }
        }
        
        public global::System.Text.StringBuilder GenerationEnvironment {
            get {
                if ((this.builder == null)) {
                    this.builder = new global::System.Text.StringBuilder();
                }
                return this.builder;
            }
            set {
                this.builder = value;
            }
        }
        
        protected global::System.CodeDom.Compiler.CompilerErrorCollection Errors {
            get {
                if ((this.errors == null)) {
                    this.errors = new global::System.CodeDom.Compiler.CompilerErrorCollection();
                }
                return this.errors;
            }
        }
        
        public string CurrentIndent {
            get {
                return this.currentIndent;
            }
        }
        
        private global::System.Collections.Generic.Stack<int> Indents {
            get {
                if ((this.indents == null)) {
                    this.indents = new global::System.Collections.Generic.Stack<int>();
                }
                return this.indents;
            }
        }
        
        public ToStringInstanceHelper ToStringHelper {
            get {
                return this._toStringHelper;
            }
        }
        
        public void Error(string message) {
            this.Errors.Add(new global::System.CodeDom.Compiler.CompilerError(null, -1, -1, null, message));
        }
        
        public void Warning(string message) {
            global::System.CodeDom.Compiler.CompilerError val = new global::System.CodeDom.Compiler.CompilerError(null, -1, -1, null, message);
            val.IsWarning = true;
            this.Errors.Add(val);
        }
        
        public string PopIndent() {
            if ((this.Indents.Count == 0)) {
                return string.Empty;
            }
            int lastPos = (this.currentIndent.Length - this.Indents.Pop());
            string last = this.currentIndent.Substring(lastPos);
            this.currentIndent = this.currentIndent.Substring(0, lastPos);
            return last;
        }
        
        public void PushIndent(string indent) {
            this.Indents.Push(indent.Length);
            this.currentIndent = (this.currentIndent + indent);
        }
        
        public void ClearIndent() {
            this.currentIndent = string.Empty;
            this.Indents.Clear();
        }
        
        public void Write(string textToAppend) {
            this.GenerationEnvironment.Append(textToAppend);
        }
        
        public void Write(string format, params object[] args) {
            this.GenerationEnvironment.AppendFormat(format, args);
        }
        
        public void WriteLine(string textToAppend) {
            this.GenerationEnvironment.Append(this.currentIndent);
            this.GenerationEnvironment.AppendLine(textToAppend);
        }
        
        public void WriteLine(string format, params object[] args) {
            this.GenerationEnvironment.Append(this.currentIndent);
            this.GenerationEnvironment.AppendFormat(format, args);
            this.GenerationEnvironment.AppendLine();
        }
        
        public class ToStringInstanceHelper {
            
            private global::System.IFormatProvider formatProvider = global::System.Globalization.CultureInfo.InvariantCulture;
            
            public global::System.IFormatProvider FormatProvider {
                get {
                    return this.formatProvider;
                }
                set {
                    if ((value != null)) {
                        this.formatProvider = value;
                    }
                }
            }
            
            public string ToStringWithCulture(object objectToConvert) {
                if ((objectToConvert == null)) {
                    throw new global::System.ArgumentNullException("objectToConvert");
                }
                global::System.Type type = objectToConvert.GetType();
                global::System.Type iConvertibleType = typeof(global::System.IConvertible);
                if (iConvertibleType.IsAssignableFrom(type)) {
                    return ((global::System.IConvertible)(objectToConvert)).ToString(this.formatProvider);
                }
                global::System.Reflection.MethodInfo methInfo = type.GetMethod("ToString", new global::System.Type[] {
                            iConvertibleType});
                if ((methInfo != null)) {
                    return ((string)(methInfo.Invoke(objectToConvert, new object[] {
                                this.formatProvider})));
                }
                return objectToConvert.ToString();
            }
        }
    }
}
